<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Document</title>

        <style>

            [contenteditable] {
                outline: none;
            }

            [contenteditable]:focus, [contenteditable]:hover{
                background-color: #e3e3e3;
            }

            .editable{
                display: flex;
                width: 1000px;
                margin: 0 auto;
            }

            #text-area{
                background-color: #f3f3f3;
                width: 1000px;
                margin: 0 auto;
            }

            .selected{
                background-color: skyblue !important;
            }
            
        </style>

        <script>
            window.onload = function(){
                var div = createDiv();
                var wrapperDiv = document.getElementById('text-area');

                linkParentChild(wrapperDiv, div);

                div.focus();
            }

            var ctrlDown;
            

            document.addEventListener('keydown', event => {

                if (event.key === 'Enter') {
                    enterkey();
                    event.preventDefault()
                }

                if (event.key === 'Backspace')
                    backspace(event);

                if (event.key === 'ArrowUp')
                    upArrow();
                

                if (event.key === 'ArrowDown')
                    downArrow();

                if (event.key === 'Control')
                    ctrlDown = true;
                
                if (ctrlDown){
                    if (event.key === 'a'){
                        ctrlA();
                        ctrlDown = false;
                    }
                }
            })

            var mouseDown = false;
            document.onmousedown = function() { 
                var editableDiv = document.getElementsByClassName("editable");
                mouseDown = true;
                if (mouseDown){
                    for(var i = 0; i < editableDiv.length; i++)
                        editableDiv[i].setAttribute('class', 'editable');
                    mouseDown = false;
                }
            }

            function enterkey() {
                var div = createDiv();

                var wrapperDiv = document.getElementById('text-area');

                linkParentChild(wrapperDiv, div);

                div.focus();

                delAllEditableSelectedDiv();
                
            }

            function backspace(e) {
                var thisTextAreaDiv = document.activeElement;
                var prevTextAreaDiv = thisTextAreaDiv.previousElementSibling;
                var isEmpty;

                isEmpty = false;

                delAllEditableSelectedDiv();

                if (document.getElementById('text-area').childElementCount == 1)
                    isEmpty = true;
                

                if (thisTextAreaDiv.hasAttribute('class', 'editable') && window.getSelection().focusOffset == 0 && !isEmpty){
                    var startContainer = prevTextAreaDiv.childNodes[0];
                    if (startContainer != null)
                        var startOffset = prevTextAreaDiv.childNodes[0].length;
                    else{
                        startContainer = prevTextAreaDiv;
                        var startOffset = 0;
                    }
                    
                    const newRange = document.createRange();
                    newRange.setStart(startContainer, startOffset);
                    newRange.collapse(true);

                    // Selection에 전달
                    const selection = document.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(newRange);

                    thisTextAreaDiv.remove();
                    e.preventDefault();
                }
                
                
            }

            function upArrow(){
                var thisTextAreaDiv = document.activeElement;
                if (thisTextAreaDiv.hasAttribute('class', 'editable'))
                    thisTextAreaDiv.previousElementSibling.focus();
            }

            function downArrow(){
                var thisTextAreaDiv = document.activeElement;
                if (thisTextAreaDiv.hasAttribute('class', 'editable'))
                    thisTextAreaDiv.nextElementSibling.focus();
            }

            function ctrlA(){
                var editableDiv = document.getElementsByClassName("editable");

                for(var i = 0; i < editableDiv.length; i++)
                    editableDiv[i].setAttribute('class', 'editable selected');
            }

            function linkParentChild(parent, child){
                if (isIterable(child))
                    for (var i = 0; i < child.length; i++)
                        parent.appendChild(child[i]);
                else
                    parent.appendChild(child);
            }

            function isIterable(obj) {
                if (obj == null) {
                    return false;
                }
                return typeof obj[Symbol.iterator] === 'function';
            }

            function delAllEditableSelectedDiv(){
                var selectedTextAreaDiv = Array.from(document.getElementsByClassName('selected')).slice();

                for (var i = 0; i < selectedTextAreaDiv.length; i++)
                    selectedTextAreaDiv[i].remove();
            }

            function createDiv(){
                var div = document.createElement("div");
                div.setAttribute('contenteditable', 'true')
                div.setAttribute('class', 'editable');

                var thisTextAreaDiv = document.activeElement;
                thisTextAreaDiv.insertAdjacentElement('afterend', div);

                return div;
            }
        </script>
    </head>
    <body>
        <div id="text-area"></div>
    </body>
</html>
